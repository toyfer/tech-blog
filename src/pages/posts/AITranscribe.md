---
layout: ../../layouts/Post.astro
title: FasterWhisperとElectronで文字起こしソフトを作成しました
---

# はじめに
 FasterWhisperを活用した文字起こしソフトをElectronで作成したのでご紹介します。

# 主な機能と用途
できること
* 音声ファイルを読み込み、文字起こしをしてCSVを出力する
* 出力したCSVと元の音声ファイルを使用して、時系列のテキスト毎に音声を再生することができる

用途としては
* 会議録作成の省力化
* 一字一句に文字起こしする場合の発言確認

などに利用する想定です。

## 文字起こし機能
以下が文字起こし機能のGUIです。  

![](https://storage.googleapis.com/zenn-user-upload/b1a87c8ea2eb-20240115.png )

上部から精度の選択、コンソール出力、ファイルパス表示欄、ファイル選択ボタン、スタートボタン、文字起こしサポーター起動（後述）のシンプルな構成からなっています。

精度と音声ファイルを選択して、スタートボタンをクリックすると処理が始まります。

![](https://storage.googleapis.com/zenn-user-upload/2229d4b84140-20240115.png)

完了すると次のように、終了していることを教えてくれます。

![](https://storage.googleapis.com/zenn-user-upload/fffb3a7d4b0f-20240115.png)

## 文字起こしサポーター機能
下部の文字起こしサポーターを起動ボタンを押下すると、文字起こしサポーターが起動します。

この画面では、出力されたCSVと元の音声を使用して、クリックしたテキストの時間から音声を再生したり、内容を確認したりすることができます。

![](https://storage.googleapis.com/zenn-user-upload/268a4975099c-20240115.png)

また、ElectronがバックエンドであることからChromium系実装のAudioPlayerでメニューから再生速度を調整することも可能です。

# 主な技術構成
| 項目 | 内容 |
| --- | --- |
| GUIフレームワーク | Electron 20.6 + Bootstrap5 |
| 音声入力変換 | FFmpeg |
| 文字起こし | FasterWhisper |
| FasterWhisper実行 | Embeddable Python 3.11.4 |

## 文字起こし処理の流れ
1. ElectronでGUI表示
2. ファイル選択時にElectronがメインプロセスでファイルパスを取得
3. スタート押下時に、精度の選択に応じて、レンダラプロセスがメインプロセスにコマンドライン引数（音声ファイルパス、使用されるモデル）を渡す
4. メインプロセスが引数をもとに子プロセスとしてFFmpegを呼び出し、一般的な非可逆圧縮（mp3、m4a）からWAV音声ファイルをTempフォルダに生成する
5. FFmpeg実行終了後、必要な引数をPythonへ渡し、PtyhonからFasterWhisperを呼び出して文字起こしを行いながら、Pythonの中で結果をCSVを出力する。
6. Pythonの終了コード発行により、メインプロセスでの処理が終了することで一連の作業が完了します。 

## 作成のきっかけ
OpenAIのWhisperが出た当時、これは自身の業務改善が見込めると思い個人で利用を進めていました。  
最初は自分だけ使用できればよかったためPythonのみを使用しbatファイルを作成して、結果のCSVを出力する機能だけ持っていました。

ここ最近になり会社でもDXが大きく取り上げられ、議事録作成の省力化などを検討していましたが、導入コストが高く費用対効果が見込めないと判断されていました。
そこで、たまたま利用環境だけはあったので、「お試しできますよ」と提案したのが始まりです。

## 開発開始
最初はC#ならGUIを比較的容易に作成し裏でPythonを実行すれば良いと開発を検討していましたが、社内で利用する関係上、個人開発ではなく、業務内で開発ができることとなったため、VisualStudio（Community版）では、ライセンス上開発を行えなくなり、別の言語とGUI実装を検討することとしました。

## Electronでの開発
ElectronはJavaScriptとNode.jsで構成されています。  
当時はフロント実装のみのポータルサイト更改を終えた時期で、JavaScriptに理解があったため、Node.jsの仕様とElectronの仕様さえ分かればUIはHTMLベースのBootstrapで楽に記述できるだろうと考えていました。

## IPCの壁
Electronでの開発は公式ドキュメントを読みながら進めましたが、ここで一番つまづきました。

Electronでは、セキュリティ上の理由から、ローカルのリソースにアクセスできるメインプロセスと画面の動作等を管理するレンダラプロセスは分離されています。  
そのため、それぞれが呼び合いレンダリングとローカル処理の実行を行うわけですが、間にエントリポイントとしてPreloadが配置されます。ここへあらかじめAPIを実装することで、お互いを呼べるようになる仕組みです。

GUI上からメインプロセス内でFFmpegとWhisperの実行が行えればと考えていましたが、この仕組みがあるために、一筋縄では行きませんでした。

### 実行結果を待っている間にGUIが更新できない
利用する側の目線からすれば、0.7倍～等倍程度（PCスペックによる）で文字起こしが実行されるので、長時間会議などの文字起こしではいつ完了するかわかりません。そのため、コンソールなどを更新し（自分のバグ修正のためにも）、利用者へ進捗を通知する必要があります。

Electron公式ドキュメントを読んで、「メインプロセスは、レンダラプロセスから`ipcMain.handle`呼んでメインプロセスの関数を実行すればいい」と思い安易に実装しました。

しかし、この関数はメインプロセスの完了を持って戻り値を受けるため、文字起こしが完了してから内容が返されることになってしまい進捗が通知できませんでした。（しばらく気づきませんでした）

最終的には、`ipcRenderer.send`と`ipcMain.on`を実装し、それぞれにメインプロセス内関数の実行、出力の戻り値をリスナーで受けてコンソールに出力する仕組みにしました。

また、レンダラプロセスで音声ファイルの時間に基づいて概ねの予測をプログレスバーで表示するようにし、さらに、OSの通知を呼び出すように設定しました。
（Windows上のグループポリシーで通知が無効にされていたため、全く動作せずに実装途中でパニックになりました）

### コンソール出力の文字化け
会社で使用しているPCはWindowsであるため、シェルは基本的にShiftJISが利用されます。対して、HTMLはUTF-8、Pythonは内部がUTF-8、Node.jsはUTF-8です。複数の仕組みを利用している関係上、コンソールへの出力が正しく受け取れない状態になってしまいました。

対応として、Node.jsから呼び出すシェルに`chcp 65001`を付与し、全体の出力をUTF-8に統一してから実行、出力を行うようにしています。

## ネットワーク制約下での開発
自身の会社では、通常業務で利用する端末はインターネットに接続されておらず画面転送でインターネットに抜けます。

そのため、実行ファイルを端末に持ってきて、npmのインストールができてもパッケージ類が利用できません。(pipなども同様)  
また、管理者権限も付与されていないので、ランタイムのインストールもハードルが高いです。

そのため、開発は全てGithubActionsとVSCode.dev(Github.dev)を活用し、Electronアプリケーションのビルド、PythonはEmbeddable版を利用し、FFmpegとFasterWhisperもビルド時にすべて取得したうえでディレクトリ構成ごとビルドを実行するようにしました。

## 文字起こしサポーターの実装
仕組み自体は全てフロントエンドで完結しています。
UIは同じくBootStrapを利用して、CSVはテーブル表示、音声ファイルはブラウザのプレイヤーを利用します。

このブラウザのプレイヤーが利用できたことで、かなりの実装を省略できました。

すでにCSVには開始時間が記録されているため、テキストをクリックした際に、プレイヤーの時間を調整して再生を走らせるだけです。

# 作った感想
とりあえず形になってよかったなと思うところが大きいです。
Node.jsの処理やVSCodeなどで実際に利用されているElectronに触れたのはデスクトップアプリケーション開発の選択肢としてとても大きな経験になりました。
また、インターネットの制約の関係上、GithubActionsやVSCode.devの学びも深めれたのが大きいです。

また、最近では趣味のコミュニティでマインクラフトのプラグイン開発を行っていますが、プラグイン開発はJavaやKotlinで開発するため、コンパイラ段階でエラーが止められることの有用性を実感しています。この流れでTypeScriptなどにも触ってみたいなと思ってます。